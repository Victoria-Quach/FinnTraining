
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.io.FileOutputStream;
import java.io.IOException;

public class excelTest {

    WebDriver driver;
    public void test() {

        // 0. Set path to and set up chromedriver
        System.setProperty("webdriver.chrome.driver", "C:\\Users\\vquach\\projects\\FinnTraining\\libs\\chromedriver117.exe");
        

        // 1. Set up ChromeOptions and add the "incognito" argument to open an incognito window
        ChromeOptions options = new ChromeOptions();
        options.addArguments("incognito");


        // 2. Initialize the webdriver, and open in full screen
        WebDriver driver = new ChromeDriver(options);
        driver.manage().window().maximize();


        // 3. Navigate to webpage and assert the page title
        driver.get("https://www.finn.no");
        Assert.assertEquals("FINN.no - mulighetenes marked", driver.getTitle());


        // 4. Navigate to frame where the "jegForstårButton" exists (the second frame in this web page with index 1)
        driver.switchTo().frame(1);


        // 5. Click on "jegForstårButton"
        WebElement jegForstårButton = driver.findElement(By.xpath("//button[@title=\"Jeg forstår\"]\r\n"));
        jegForstårButton.click();


        // 6. Switch back to main content
        driver.switchTo().defaultContent();


        // 7. Click on Log in
        WebElement element = driver.findElement(By.xpath("//*[@id=\"frontpage-content\"]/finn-topbar")).getShadowRoot().findElement(By.cssSelector("header > nav > a:nth-child(5)"));
        element.click();


        // 8. Wait
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(5)); // 10 seconds timeout
        By yourElementLocator = By.id("username"); 
        WebElement username = wait.until(ExpectedConditions.presenceOfElementLocated(By.id("username")));
        WebElement password = wait.until(ExpectedConditions.presenceOfElementLocated(By.id("password")));


        // 9. Now, you can interact with the element
        username.sendKeys("ingvild.svendsen@expleogroup.com");
        password.sendKeys("Expleo123");


        // 10. Click log in
        driver.findElement(By.xpath("//*[@id=\"ActionButton_0\"]")).click();


        // 11. Click on Reise
        WebDriverWait wait2 = new WebDriverWait(driver, Duration.ofSeconds(10)); // 10 seconds timeout
        By yourElementLocator2 = By.id("reise"); 
        WebElement reiseElement = wait.until(ExpectedConditions.presenceOfElementLocated(By.linkText("Reise")));
        reiseElement.click();


        // 12. Type in Oslo
        WebElement FlyFra = driver.findElement(By.xpath("//*[@id=\"origin-roundtrip\"]"));
        FlyFra.sendKeys("Oslo lufthavn Gardermoen");

        try {
            Thread.sleep(500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        FlyFra.sendKeys(Keys.RETURN);


        // 13. Type in Barcelona
        WebElement FlyTil = driver.findElement(By.xpath("//*[@id=\"destination-roundtrip\"]"));
        FlyTil.sendKeys("Barcelona");

         try {
            Thread.sleep(500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        FlyTil.sendKeys(Keys.RETURN);


        // 14. Choose dates departure and return
        WebElement datoUtreise = driver.findElement(By.xpath("//*[@id=\"date-roundtrip-outbound\"]"));
        datoUtreise.click();
        // Press arrow next month
        driver.findElement(By.xpath("//button[@class='button button--pill button--small absolute right-10 top-4']")).click();
        // Choose dates for departure and return
        driver.findElement(By.xpath("//td[@aria-label='onsdag 8. november 2023']")).click();
        driver.findElement(By.xpath("//td[@aria-label='torsdag 16. november 2023']")).click();


        // 15. Unclick on Hotell and click Search
        driver.findElement(By.xpath("//label[@for='openHotelSearch']")).click();
        driver.findElement(By.xpath("//button[@data-testid='flightSearchButton']")).click();


        // 16. Choose direct flight
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
 
        WebElement radioButtonDirekte = driver.findElement(By.xpath("//label[@for='stopoverFilter0']"));
        radioButtonDirekte.click();

       
        // 17. Choose times for departure and return (SLIDER)


        //AVGANG UTREISE
         try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

          // Choose tider (beginning of interval)
          String desiredTravelTimeStart = "06:00";
          String desiredTravelTimeStop = "12:00";
          WebElement sliderTravelTimeStart = driver.findElement(By.xpath("//div[@aria-label='Utreise tidligst'][@role='slider']"));
          String currentTimeStart = sliderTravelTimeStart.getAttribute("aria-valuetext").split(" ")[1];
          sliderTravelTimeStart.click();
  
          //Assert.assertEquals(desiredTravelTimeStart, currentTimeStart);
          while (!desiredTravelTimeStart.equals(currentTimeStart)){
              System.out.println("Desired travel time start:" + desiredTravelTimeStart + "." + "\nCurrent time start:" + currentTimeStart  + ".");
              sliderTravelTimeStart.sendKeys(Keys.ARROW_RIGHT);
              currentTimeStart = sliderTravelTimeStart.getAttribute("aria-valuetext").split(" ")[1];
          }
  
          // Choose tider (end of interval)
          WebElement sliderTravelTimeStop = driver.findElement(By.xpath("//div[@aria-label='Utreise senest'][@role='slider']"));
          String currentTimeStop = sliderTravelTimeStop.getAttribute("aria-valuetext").split(" ")[1];
          sliderTravelTimeStop.click();
          while (!desiredTravelTimeStop.equals(currentTimeStop)){
              sliderTravelTimeStop.sendKeys(Keys.ARROW_LEFT);
              currentTimeStop = sliderTravelTimeStop.getAttribute("aria-valuetext").split(" ")[1];
          }

          System.out.println("Desired travel time start " + desiredTravelTimeStart + "\n current time start " + currentTimeStart);
          System.out.println("Desired travel time stop " + desiredTravelTimeStop + "\n current time stop " + currentTimeStop);


        // 18. Choose maksimum travel time

        // Choose desired maximum travel time and slide until the desired time is reached
        int desiredTravelTime = 8;
        // Locate the slider element for maximum travel time
        WebElement sliderTravelTime = driver.findElement(By.xpath("//div[@aria-label='Maks reisetid'][@role='slider']"));
        // Get the current maximum travel time from the slider's aria-valuetext attribute
        String maxTravelTime = sliderTravelTime.getAttribute("aria-valuetext");
        // Convert the maximum travel time from String to an integer (skille der det står mellomrom, og 0 er det første elementet etter mellomrommet)
        int TravelTime = Integer.parseInt(maxTravelTime.split(" ")[0]);
        // Move the slider left until the desired travel time is reached
        for (int i = 0; i < (TravelTime - desiredTravelTime); i++ ){
            sliderTravelTime.sendKeys(Keys.ARROW_LEFT);
        }
        // Check that the slider has the desired value
        String aria_valuetext = sliderTravelTime.getAttribute("aria-valuetext");
        Assert.assertEquals(desiredTravelTime, Integer.parseInt(aria_valuetext.split(" ")[0]));

        System.out.println("AriaValueText = "+ aria_valuetext);

    



        // Replace 'htmlContent' with the actual HTML content of the specified element
        String htmlContent = """
                <section data-testid="lowfareCalendar" class="bg-aqua-50 relative p-16 rounded-8 mt-4" aria-label="Lavpriskalender"><div class="font-normal whitespace-nowrap pb-16">Prøv lavpriskalenderen<span class="font-normal text-12 text-gray-500 whitespace-nowrap pl-16" data-testid="lowfareSavings">Du kan spare 1 657 kr</span></div><div class="relative" data-testid="lowfareDetails"><div data-testid="outboundText" class="Lowfare_outbound__8ilyH font-bold" aria-hidden="true">Utreise →</div><div data-testid="inboundText" class="Lowfare_inbound__b72zg font-bold" aria-hidden="true">Hjemreise →</div><div data-testid="lowfareCalendarStatus" class="sr-only">Valgt utreisedato: 2023-10-12Valgt hjemreisedato: 2023-10-14.</div><div data-testid="tableInfoRoundtrip" class="sr-only">Skjermlesere: Tabellen nedenfor er en krysstabell. Første rad inneholder dager for utreise, mens siste kolonne inneholder dager for hjemreise.</div><table id="lowfareTable" data-testid="lowfareTable" class="LowfareTable_table__Bu01X text-center"><thead><tr><td class="border-b-2" data-departure-date="2023-10-09" data-row="0" data-col="0">ma. 09.10</td><td class="border-b-2" data-departure-date="2023-10-10" data-row="0" data-col="1">ti. 10.10</td><td class="border-b-2" data-departure-date="2023-10-11" data-row="0" data-col="2">on. 11.10</td><td class="border-b-2 selection-path font-bold" data-departure-date="2023-10-12" data-row="0" data-col="3">to. 12.10</td><td class="border-b-2" data-departure-date="2023-10-13" data-row="0" data-col="4">fr. 13.10</td><td class="border-b-2" data-departure-date="2023-10-14" data-row="0" data-col="5">lø. 14.10</td><td class="border-b-2" data-departure-date="2023-10-15" data-row="0" data-col="6">sø. 15.10</td><td class="LowfareTable_return__LFeP0"></td></tr></thead><tbody><tr><td class="border bg-aqua-50 border-l-2" data-row="1" data-col="0"></td><td class="border bg-aqua-50" data-row="1" data-col="1"></td><td class="border bg-aqua-50" data-row="1" data-col="2"></td><td class="border bg-aqua-50 selection-path" data-row="1" data-col="3"></td><td class="border bg-aqua-50" data-row="1" data-col="4"></td><td class="border bg-aqua-50" data-row="1" data-col="5"></td><td class="border bg-aqua-50" data-row="1" data-col="6"></td><td class="border-l-2 text-left bg-aqua-50 LowfareTable_return__LFeP0" data-return-date="2023-10-11" data-row="1" data-col="7">on. 11.10</td></tr><tr><td class="border bg-aqua-50 border-l-2" data-row="2" data-col="0"></td><td class="border bg-aqua-50" data-row="2" data-col="1"></td><td class="border bg-aqua-50" data-row="2" data-col="2"></td><td class="bg-white text-gray-500 selection-path border cursor-pointer" data-row="2" data-col="3" data-date-id="2023-10-12_2023-10-12" title="Bli den første til å søke på denne datoen" tabindex="-1">Søk</td><td class="border bg-aqua-50" data-row="2" data-col="4"></td><td class="border bg-aqua-50" data-row="2" data-col="5"></td><td class="border bg-aqua-50" data-row="2" data-col="6"></td><td class="border-l-2 text-left bg-aqua-50 LowfareTable_return__LFeP0" data-return-date="2023-10-12" data-row="2" data-col="7">to. 12.10</td></tr><tr><td class="border bg-aqua-50 border-l-2" data-row="3" data-col="0"></td><td class="border bg-aqua-50" data-row="3" data-col="1"></td><td class="border bg-aqua-50" data-row="3" data-col="2"></td><td class="bg-white text-gray-700 selection-path border-2 border-gray-700 font-bold" data-row="3" data-col="3" data-has-price="2906" data-date-id="2023-10-12_2023-10-13" title="Klikk for å oppdatere prisen" tabindex="0" data-selected="true">2 906 kr</td><td class="bg-white text-gray-700 selection-path border cursor-pointer" data-row="3" data-col="4" data-has-price="2725" data-date-id="2023-10-13_2023-10-13" title="Klikk for å oppdatere prisen" tabindex="-1">2 725 kr</td><td class="border bg-aqua-50 selection-path" data-row="3" data-col="5"></td><td class="border bg-aqua-50 selection-path" data-row="3" data-col="6"></td><td class="border-l-2 text-left bg-aqua-50 LowfareTable_return__LFeP0 selection-path font-bold" data-return-date="2023-10-13" data-row="3" data-col="7">fr. 13.10</td></tr><tr><td class="border bg-aqua-50 border-l-2" data-row="4" data-col="0"></td><td class="border bg-aqua-50" data-row="4" data-col="1"></td><td class="border bg-aqua-50" data-row="4" data-col="2"></td><td class="bg-white text-gray-700 border cursor-pointer" data-row="4" data-col="3" data-has-price="3670" data-date-id="2023-10-12_2023-10-14" title="Klikk for å oppdatere prisen" tabindex="-1">3 670 kr</td><td class="bg-white text-gray-700 border cursor-pointer" data-row="4" data-col="4" data-has-price="2206" data-date-id="2023-10-13_2023-10-14" title="Klikk for å oppdatere prisen" tabindex="-1">2 206 kr</td><td class="bg-white text-gray-500 border cursor-pointer" data-row="4" data-col="5" data-date-id="2023-10-14_2023-10-14" title="Bli den første til å søke på denne datoen" tabindex="-1">Søk</td><td class="border bg-aqua-50" data-row="4" data-col="6"></td><td class="border-l-2 text-left bg-aqua-50 LowfareTable_return__LFeP0" data-return-date="2023-10-14" data-row="4" data-col="7">lø. 14.10</td></tr><tr><td class="border bg-aqua-50 border-l-2" data-row="5" data-col="0"></td><td class="border bg-aqua-50" data-row="5" data-col="1"></td><td class="border bg-aqua-50" data-row="5" data-col="2"></td><td class="bg-white text-gray-700 border cursor-pointer" data-row="5" data-col="3" data-has-price="3740" data-date-id="2023-10-12_2023-10-15" title="Klikk for å oppdatere prisen" tabindex="-1">3 740 kr</td><td class="bg-white text-gray-700 border cursor-pointer" data-row="5" data-col="4" data-has-price="3256" data-date-id="2023-10-13_2023-10-15" title="Klikk for å oppdatere prisen" tabindex="-1">3 256 kr</td><td class="bg-white text-gray-700 border cursor-pointer" data-row="5" data-col="5" data-has-price="3040" data-date-id="2023-10-14_2023-10-15" title="Klikk for å oppdatere prisen" tabindex="-1">3 040 kr</td><td class="bg-white text-gray-500 border cursor-pointer" data-row="5" data-col="6" data-date-id="2023-10-15_2023-10-15" title="Bli den første til å søke på denne datoen" tabindex="-1">Søk</td><td class="border-l-2 text-left bg-aqua-50 LowfareTable_return__LFeP0" data-return-date="2023-10-15" data-row="5" data-col="7">sø. 15.10</td></tr><tr><td class="border bg-aqua-50 border-l-2" data-row="6" data-col="0"></td><td class="border bg-aqua-50" data-row="6" data-col="1"></td><td class="border bg-aqua-50" data-row="6" data-col="2"></td><td class="bg-white text-gray-700 border cursor-pointer" data-row="6" data-col="3" data-has-price="2544" data-date-id="2023-10-12_2023-10-16" title="Klikk for å oppdatere prisen" tabindex="-1">2 544 kr</td><td class="bg-white text-gray-700 border cursor-pointer" data-row="6" data-col="4" data-has-price="2396" data-date-id="2023-10-13_2023-10-16" title="Klikk for å oppdatere prisen" tabindex="-1">2 396 kr</td><td class="bg-white text-gray-700 border cursor-pointer" data-row="6" data-col="5" data-has-price="2072" data-date-id="2023-10-14_2023-10-16" title="Klikk for å oppdatere prisen" tabindex="-1">2 072 kr</td><td class="bg-white text-gray-500 border cursor-pointer" data-row="6" data-col="6" data-date-id="2023-10-15_2023-10-16" title="Bli den første til å søke på denne datoen" tabindex="-1">Søk</td><td class="border-l-2 text-left bg-aqua-50 LowfareTable_return__LFeP0" data-return-date="2023-10-16" data-row="6" data-col="7">ma. 16.10</td></tr><tr><td class="border bg-aqua-50 border-l-2 border-b-2" data-row="7" data-col="0"></td><td class="border bg-aqua-50 border-b-2" data-row="7" data-col="1"></td><td class="border bg-aqua-50 border-b-2" data-row="7" data-col="2"></td><td class="bg-white text-gray-700 border-b-2 border cursor-pointer" data-row="7" data-col="3" data-has-price="2132" data-date-id="2023-10-12_2023-10-17" title="Klikk for å oppdatere prisen" tabindex="-1">2 132 kr</td><td class="bg-white text-gray-700 border-b-2 border cursor-pointer" data-row="7" data-col="4" data-has-price="2135" data-date-id="2023-10-13_2023-10-17" title="Klikk for å oppdatere prisen" tabindex="-1">2 135 kr</td><td class="bg-white text-gray-700 border-b-2 border cursor-pointer" data-row="7" data-col="5" data-has-price="1879" data-date-id="2023-10-14_2023-10-17" title="Klikk for å oppdatere prisen" tabindex="-1">1 879 kr</td><td class="bg-white text-gray-500 border-b-2 border cursor-pointer" data-row="7" data-col="6" data-date-id="2023-10-15_2023-10-17" title="Bli den første til å søke på denne datoen" tabindex="-1">Søk</td><td class="border-l-2 text-left bg-aqua-50 LowfareTable_return__LFeP0" data-return-date="2023-10-17" data-row="7" data-col="7">ti. 17.10</td></tr></tbody></table><div class="text-center font-bold mt-8" data-testid="lowfareNumberOfDays">2 dagers reise</div><div class="text-12 text-gray-500 text-center">Prisene er basert på tidligere søk og kan endre seg</div><hr class="my-8"><div class="flex justify-between"><div><button data-testid="lowfarePrevious" class="button button--link whitespace-nowrap">7 dager tidligere</button></div><div class="text-right"><button data-testid="lowfareNext" class="button button--link whitespace-nowrap">7 dager senere</button><div data-testid="lowfareNextLabel" class="text-12 text-gray-500">Du kan spare 97 kr</div></div></div></div></section>
        """;

        // Parse the HTML content
        Document doc = Jsoup.parse(htmlContent);

        // Create a new Excel workbook
        try (Workbook workbook = new XSSFWorkbook()) {
            // Create a sheet
            Sheet sheet = workbook.createSheet("ScrapedData");

            // Find the desired elements using Jsoup selectors
            Element lowfareDetails = doc.selectFirst("section[data-testid=lowfareCalendar]");
            Element outboundText = lowfareDetails.selectFirst("div[data-testid=outboundText]");
            Element inboundText = lowfareDetails.selectFirst("div[data-testid=inboundText]");
            Elements tableRows = lowfareDetails.select("table[data-testid=lowfareTable] tr");

            // Create a row for outbound and inbound text
            Row row1 = sheet.createRow(0);
            row1.createCell(0).setCellValue("Outbound Text");
            row1.createCell(1).setCellValue(outboundText.text());

            Row row2 = sheet.createRow(1);
            row2.createCell(0).setCellValue("Inbound Text");
            row2.createCell(1).setCellValue(inboundText.text());

            // Create a header row for the table
            Row headerRow = sheet.createRow(3);
            headerRow.createCell(0).setCellValue("Date");
            headerRow.createCell(1).setCellValue("Column 1");
            headerRow.createCell(2).setCellValue("Column 2");
            // Add more columns as needed

            // Extract and write table data
            int rowNum = 4; // Start from the fifth row for table data
            for (Element row : tableRows) {
                Elements rowCells = row.select("td, th");
                Row excelRow = sheet.createRow(rowNum++);
                int cellNum = 0;
                for (Element cell : rowCells) {
                    excelRow.createCell(cellNum++).setCellValue(cell.text());
                }
            }

            // Write the workbook content to an Excel file
            try (FileOutputStream fileOut = new FileOutputStream("ScrapedData.xlsx")) {
                workbook.write(fileOut);
                System.out.println("Excel file created successfully.");
            } catch (IOException e) {
                e.printStackTrace();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
}

